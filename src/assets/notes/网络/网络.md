## TCP/IP 协议族

### TCP/IP 网络模型

TCP/IP 是互联网相关的各类协议族的总称，比如：TCP，UDP，IP，FTP，HTTP，ICMP，SMTP 等都属于 TCP/IP 族内的协议。

这些协议可以划分为四层，应用层，传输层，网络层，数据链路层。

- 应用层：负责向用户提供应用程序，比如 HTTP、FTP、Telnet、DNS、SMTP 等
- 传输层：负责对报文进行分组和重组，并以 TCP 或 UDP 协议格式封装报文
- 网络层：负责路由以及把分组报文发送给目标网络或主机
- 数据链路层：负责封装和解封装 IP 报文，发送和接受 ARP/RARP 报文等

![img](https://image.fundebug.com/2019-03-21-01.png)

HTTP属于应用层。

### UDP 和 TCP 的区别

TCP 和 UDP 都位于计算机网络模型中的**传输层**，他们负责传输应用层产生的数据。

#### UDP是什么

UDP 的全程是 User Datagram Protocol，用户数据报协议。它不需要所谓的**握手**操作，从而加快了通信速度，允许网络上的其他主机在接收方同意通信之前进行数据传输。

**特点**：

- UDP 能够支持容忍数据包丢失的带宽密集型应用程序
- 面向无连接
- 有单播、多播、广播的功能
- UDP 具有低延迟的特点
- UDP 能够发送大量的数据包
- UDP 能够允许 DNS 查找，DNS 是建立在 UDP 之上的应用层协议

#### TCP 是什么

TCP 的全称是`Transmission Control Protocol` ，传输控制协议。它能够帮助你确定计算机连接到 Internet 以及它们之间的数据传输。通过三次握手来建立 TCP 连接，三次握手就是用来启动和确认 TCP 连接的过程。一旦连接建立后，就可以发送数据了，当数据传输完成后，会通过关闭虚拟电路来断开连接。

特点：

- TCP 能够确保连接的建立和数据包的发送
- TCP 支持错误重传机制
- TCP 支持拥塞控制，能够在网络拥堵的情况下延迟发送
- TCP 能够提供错误校验和，甄别有害的数据包。

<img src="D:\notes\images\640.png" style="zoom:80%;" />

### TCP 三次握手和四次挥手

在了解具体流程前，需要认识几个概念：

| **消息类型** | **描述**                           |
| ------------ | ---------------------------------- |
| SYN          | 用来初始化和建立连接               |
| ACK          | 帮助对方确认收到的 SYN 消息        |
| SYN-ACK      | 本地的 SYN 消息和较早的 ACK 数据包 |
| FIN          | 用来断开连接                       |

#### 三次握手

- SYN：它的全称是 `Synchronize Sequence Numbers`，同步序列编号。是 TCP/IP 建立连接时使用的握手信号。在客户机和服务器之间建立 TCP 连接时，首先会发送的一个信号。客户端在接受到 SYN 消息时，就会在自己的段内生成一个随机值 X。
- SYN-ACK：服务器收到 SYN 后，打开客户端连接，发送一个 SYN-ACK 作为答复。确认号设置为比接收到的序列号多一个，即 X + 1，服务器为数据包选择的序列号是另一个随机数 Y。
- ACK：`Acknowledge character`, 确认字符，表示发来的数据已确认接收无误。最后，客户端将 ACK 发送给服务器。序列号被设置为所接收的确认值即 Y + 1。

<img src="D:\notes\images\微信图片_20200625012118.png" style="zoom:50%;" />

#### 四次挥手

<img src="D:\notes\images\微信图片_20200625012133.png" style="zoom:50%;" />

- 首先，客户端应用程序决定要终止连接(这里服务端也可以选择断开连接)。这会使客户端将 FIN 发送到服务器，并进入 `FIN_WAIT_1` 状态。当客户端处于 FIN_WAIT_1 状态时，它会等待来自服务器的 ACK 响应。
- 然后第二步，当服务器收到 FIN 消息时，服务器会立刻向客户端发送 ACK 确认消息。
- 当客户端收到服务器发送的 ACK 响应后，客户端就进入 `FIN_WAIT_2` 状态，然后等待来自服务器的 `FIN` 消息
- 服务器发送 ACK 确认消息后，一段时间（可以进行关闭后）会发送 FIN 消息给客户端，告知客户端可以进行关闭。
- 当客户端收到从服务端发送的 FIN 消息时，客户端就会由 FIN_WAIT_2 状态变为 `TIME_WAIT` 状态。处于 TIME_WAIT 状态的客户端允许重新发送 ACK 到服务器为了防止信息丢失。客户端在 TIME_WAIT 状态下花费的时间取决于它的实现，在等待一段时间后，连接关闭，客户端上所有的资源（包括端口号和缓冲区数据）都被释放。

### Get 和 POST 有什么区别

1. 语义上的区别。
2. **缓存**角度：GET 请求会被浏览器主动缓存下来，留下历史记录，而 POST 默认不会。
3. **编码**角度：GET 只能进行 URL 编码，只能接受 ASCII 字符，而 POST 没有限制。
4. **参数**角度：GET 一般放在 URL 中，不安全，POST 放在请求体中，更适合传输敏感信息。
5. **幂等性**角度：GET 是幂等的，而 POST 不是。（幂等：执行相同的操作，返回结果一样）
6. **TCP**角度：GET 会把请求报文一次性发出去，而 POST 会分为两个 TCP 数据包，首先发 header 部分，如果服务器响应 100，然后发 body 部分。（火狐除外）

### HTTP  的缺点

- 通信使用明文（不加密），内容可能会被窃听
- 不验证通信方的身份，因此有可能遭遇伪装
- 无法验证报文的完整性，所以有可能已遭篡改

## HTTPS

HTTP 协议中没有加密机制，但可以通过和 SSL（Secure Socket Layer，安全套接字）或 TLS（Transfer Layer Security，安全传输层协议）的组合使用，加密 HTTP 的通信内容。这种添加了加密及认证机制（证书）的 HTTP 就被称为 HTTPS。

通常，HTTP 直接和 TCP 通信。当使用 SSL 时，则变为先和 SSL 通信，再由 SSL 和 TCP 通信，所谓 HTTPS，就是身披 SSL 协议这层外壳的 HTTP。

### 共享密钥加密

加密和解密用同一个密钥的方式称为共享密钥加密（Common key crypto system）。

### 公开密钥加密

SSL 采用一种叫做**公开密钥加密**的加密处理方式。

公开密钥加密使用一对非对称的密钥。一把叫做**私有密钥**（private key），一把叫做**公开密钥**（public key）。

使用公开密钥加密方式，发送密文的一方使用对方的**公开密钥**进行加密处理，对方收到被加密的信息后，再使用自己的**私有密钥**进行解密。

### HTTPS 采用混合加密机制

HTTPS 采用共享密钥加密和公开密钥加密两者并用的混合加密机制。若密钥能够实现安全交换，那么有可能会考虑仅使用公开密钥加密来通信。但是公开密钥加密与共享密钥加密相比，其处理速度要慢。

所以应充分利用两者各自的优势，将多种方法组合起来用于通信。在交换密钥环节使用公开密钥加密方式，之后的建立通信交换报文阶段则使用共享密钥加密方式。

1. 使用公开密钥加密方式安全地交换在稍后的共享密钥加密中要使用的密钥。
2. 确保交换的密钥是安全的前提下，使用共享密钥加密方式进行通信

### 证书

首先，服务器的运营人员向数字证书认证机构提出公开密钥的申请。数字证书认证机构在判明提出申请者的身份之后，会对已申请的公开密钥做数字签名，然后分配这个已签名的公开密钥，并将该公开密钥放入公钥证书后绑定在一起。

服务器会将这份由数字证书认证机构颁发的公钥证书发送给客户端，以进行公开密钥加密方式通信。接到证书的客户端可使用**数字证书认证机构**的公开密钥，对那张证书上的数字签名进行验证，一旦验证通过，客户端便可明确两件事：一，认证服务器的公开密钥是真实有效的数字证书认证机构。二，服务器的公开密钥是值得信赖的。

#### 过程

（1）服务器把自己的公开密钥登录至数字证书认证机构

（2）数字证书认证机构用自己的私有密钥向服务器的公开密钥部署数字签名并颁发公钥证书

（3）客户端拿到服务器的公钥证书后，使用数字证书认证机构的公开密钥，向数字证书认证机构验证公钥证书上的数字签名，以确认服务器的公开密钥的真实性

（4）使用服务器的公开密钥对报文加密后发送

（5）服务器用私有密钥对报文进行解密

> 如果劫持了证书并修改，但是在客户端验证签名的时候必须要成功，所以签名不会变，只会改公钥，但是这样这个证书在 CA 那里就会验证失败？？？

